# coding: utf-8
module WechatAuth
  class GetCodeUri
    # require 'uri'
    attr_reader :appid, :redirect_uri, :scope, :state
    # code说明 ： code作为换取access_token的票据，每次用户授权带上的code将不一样，code只能使用一次，5分钟未被使用自动过期。 
    def initialize( params = {} )
      # params hash
      # appid default qianyan subscribe: wx2e050b0a651b968b
      @appid = params[:appid] || "wx37860e03b3e55945"
      @redirect_uri = params[:redirect_uri]
      # default snsapi_base
      @scope = params[:scope] || "snsapi_base"
      @state = SecureRandom.base58(32)
    end
    
    def snsapi
      # new(scheme, userinfo, host, port, registry, path, opaque, query, fragment, parser = DEFAULT_PARSER, arg_check = false)
      # fragment: A part of URI after ‘#’ sign
      host = 'open.weixin.qq.com'
      path = '/connect/oauth2/authorize'
  
      URI::HTTPS.new('https', nil, host, nil, nil, path, nil, query, "wechat_redirect")
      # https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect
    end

    def path
      # URI.escape(snsapi.to_s)
      snsapi.to_s
    end

    def query
      qh = {appid: appid, redirect_uri: redirect_uri, response_type: :code, scope: scope, state: state}
      URI.encode_www_form qh
    end
    
    end
end
